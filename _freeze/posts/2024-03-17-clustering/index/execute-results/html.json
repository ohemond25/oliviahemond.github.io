{
  "hash": "7183ed19b49ec09059fa55b12199fc75",
  "result": {
    "markdown": "---\ntitle: \"Hierarchical Clustering\"\ndescription: \"Using agglomerative hierarchical clustering to group stream sites by water chemistry\"\nauthor: \"Olivia Hemond\"\ndate: 03-17-2024\nimage: fig3.png\ndraft: false\ncategories: [R, Visualization, Clustering]\nformat: \n  html:\n    code-fold: show\n    toc: true\n    embed-resources: true\neditor: visual\ntheme: flatly\nexecute: \n  echo: true\n  message: false\n  warning: false\n---\n\n\n# Overview\n\n## Data Summary\n\nThe data used for this analysis were collected for the Santa Barbara Coastal Long Term Ecological Research Network (SBC LTER). This dataset consists of water chemistry measurements taken from streams in Santa Barbara beginning in 2000. Key variables measured include ammonium, nitrate, phosphorous, nitrogen and phosphorous (dissolved), carbon, nitrogen, & phosphorous (particulate), total suspended solids, and conductivity.\n\n**Data source:**\n\nSanta Barbara Coastal LTER and J. Melack. 2019. SBC LTER: Land: Stream chemistry in the Santa Barbara Coastal drainage area, ongoing since 2000 ver 16. Environmental Data Initiative. <https://doi.org/10.6073/pasta/67a558a24ceed9a0a5bf5e46ab841174>\n\n## Purpose\n\nThe purpose of this analysis is to cluster stream sites based upon their water chemistry similarities and dissimilarities. There are 13 study sites in the data set, located along various streams. Clustering may reveal patterns in the data and similarities between sites that may be otherwise hard to observe given the many water quality parameters measured.\n\n## Analytical Outline\n\nI will use agglomerative (bottom-up) hierarchical clustering to group together individual stream sites based upon similarity. Specifically, I use the following analytical process:\n\n1.  Get and tidy data\n\n2.  Remove water chemistry variables with many NAs (\\> 50% of observations)\n\n3.  Calculate, for each stream site, the mean values for the remaining water chemistry parameters. Remove remaining NAs in the process\n\n4.  Scale the data\n\n5.  Create Euclidean distance matrix\n\n6.  Perform hierarchical clustering by complete linkage\n\n7.  Perform hierarchical clustering by single linkage and compare with the complete linkage results\n\n# Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(dendextend) # for dendrogram plotting\nlibrary(ggdendro) # for dendogram plotting in ggplot\n```\n:::\n\n\n### Get data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read in data, replacing -999 values with NA\nstream <- read_csv(here::here('posts', '2024-03-17-clustering', 'data', 'sbc_lter_registered_stream_chemistry.csv'), na = \"-999\") \n```\n:::\n\n\n### Remove NAs, calculate means, and scale\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Examined the distribution of NAs in the dataset\nstream %>% \n  summary()\n```\n:::\n\n\nWhen I examined the dataset, it was clear that four columns contained too many NAs to be useful in this analysis (\\> 50% of all observations). These four columns are for total particulate carbon, total particulate nitrogen, total particulate phosphorous, and total suspended solids. So, I will remove them from the dataset.\n\nEven once those columns are removed, there are other incomplete observations in this dataset. In some cases, it may be necessary to drop all incomplete observations. However, in this case, there does not seem to be a systematic bias to which observations are incomplete. If I dropped all incomplete observations, I would lose about 1/3 of the data. So, I instead will remove NAs when I summarize and take the mean of each column, that way I am minimizing data loss.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstream_scale <- stream %>% \n  select(!tpc_uM:tss_mgperLiter) %>% # remove the four columns with many NAs\n  group_by(site_code) %>% \n  summarize(across(nh4_uM:spec_cond_uSpercm, ~mean(.x, na.rm = TRUE))) %>% # remove NAs while summarizing\n  select(-site_code) %>% # remove non-numeric column\n  scale() # scale data so that skew or spread of data points does not have a large impact on clustering\n```\n:::\n\n\n### Create Euclidean distance matrix\n\nNext, I create a Euclidean distance matrix with my scaled data. This calculates the distance between every possible pair of stream sites.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstream_dist <- dist(stream_scale, method = \"euclidean\")\n```\n:::\n\n\n### Hierarchical clustering with complete linkage\n\nUsing the pairwise distances, I can now cluster my data. Stream sites with the smallest Euclidean distance between them will be clustered together first, and clustering will continue using the next smallest pairwise distance. Since I'm using complete linkage, two clusters are joined into one using the *maximum* distance between two observations in those clusters.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Perform clustering with complete linkage\nstream_hc_comp <- hclust(stream_dist, method = \"complete\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create dendrogram\nggdendrogram(stream_hc_comp) +\n  theme_minimal() +\n  theme(panel.grid.major = element_blank(), \n        panel.grid.minor = element_blank(),\n        axis.text.x = element_text(size = 14, \n                                   color = \"orchid3\", \n                                   face = \"bold\"),\n        axis.title = element_text(size = 12, face = \"bold\")) +\n  labs(x = \"\\nStream Site\", y = \"Distance\\n\")\n```\n\n::: {.cell-output-display}\n![Dendrogram showing results of agglomerative hierarchical clustering by complete linkage for the thirteen different stream study sites.](index_files/figure-html/fig-HC_complete-1.png){#fig-HC_complete width=672}\n:::\n:::\n\n\n### Hierarchical clustering with single linkage\n\nI wanted to rerun the clustering analysis, this time using single linkage instead of complete. In other words, clusters will now be joined together using the *minimum* pairwise distance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstream_hc_sing <- hclust(stream_dist, method = \"single\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create dendrogram\nggdendrogram(stream_hc_sing) +\n  theme_minimal() +\n  theme(panel.grid.major = element_blank(), \n        panel.grid.minor = element_blank(),\n        axis.text.x = element_text(size = 14, \n                                   color = \"coral\", \n                                   face = \"bold\"),\n        axis.title = element_text(size = 12, face = \"bold\")) +\n  labs(x = \"\\nStream Site\", y = \"Distance\\n\")\n```\n\n::: {.cell-output-display}\n![Dendrogram showing results of agglomerative hierarchical clustering by single linkage for the thirteen different stream study sites.](index_files/figure-html/fig-HC_single-1.png){#fig-HC_single width=672}\n:::\n:::\n\n\n### Compare complete and single linkage results\n\nTo easily and visually compare differences between the two dendrograms, I made a tanglegram.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert to class dendrogram\ndend_complete <- as.dendrogram(stream_hc_comp)\ndend_simple <- as.dendrogram(stream_hc_sing)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Measure alignment quality - lower is better. Find the method that produces the lowest result\nentanglement(dend_complete, dend_simple) # lower is better\n# [1] 0.510256\n\nuntangle(dend_complete, dend_simple, method = \"step1side\") %>% \n  entanglement()\n# [1] 0.04944589\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nuntangle(dend_complete, dend_simple, method = \"step1side\") %>% \n   tanglegram(common_subtrees_color_branches = TRUE,\n              main_left = \"Complete\",\n              main_right = \"Single\")\n```\n\n::: {.cell-output-display}\n![Tanglegram comparing the results of hierarchical clustering by complete linkage (left) and single linkage (right) for the thirteen different stream study sites. Identical stream labels are connected by lines. Colored lines connect sub-trees present in both dendrograms. Sub-trees unique to each dendrogram are shown with dashed lines.](index_files/figure-html/fig-tangle-1.png){#fig-tangle width=672}\n:::\n:::\n\n\n# Conclusions\n\n-   Stream sites 1, 7, and 12 are highly similar in both clustering analyses.\n-   Stream sites 6, 9, and 11 are highly similar in both clustering analyses.\n-   Site 4 is the most dissimilar from all other sites.\n-   The type of linkage clustering used affects the identities of the resulting clusters, especially at the level of creating four or five clusters.\n-   These results can be used to examine stream clusters and identify underlying anthropogenic or environmental factors leading to their similarities and dissimilarities in water chemistry.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}